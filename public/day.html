<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <title>Food Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/tracker.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* Page container styling handled by tracker.css */
        
        .summary-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .summary-info {
            margin-bottom: 1.5rem;
        }

        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .date-display {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .calorie-summary {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .calorie-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .calorie-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .calorie-value {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            min-width: 80px;
            text-align: center;
        }

        .progress-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .progress-link:hover {
            background: rgba(255, 255, 255, 0.3);
            text-decoration: none;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .add-food-btn {
            background: #28a745;
            color: white;
        }

        .add-food-btn:hover {
            background: #218838;
        }

        .add-meal-btn {
            background: #007bff;
            color: white;
        }

        .add-meal-btn:hover {
            background: #0056b3;
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e0e0e0;
        }



        #dayList {
            padding: 0;
            margin: 0;
        }

        .empty-day {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-style: italic;
        }

        .meal-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .meal-header:hover {
            background: #e9ecef;
        }

        .meal-item.collapsed .meal-header {
            border-bottom: none;
        }

        .meal-info {
            flex: 1;
        }

        .meal-title {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
            text-transform: capitalize;
        }

        .meal-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-add-meal, .btn-edit-meal, .btn-delete-meal {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-meal:hover {
            background: #0056b3;
        }

        .btn-edit-meal {
            background: #6c757d;
        }

        .btn-edit-meal:hover {
            background: #545b62;
        }

        .btn-delete-meal {
            background: #dc3545;
        }

        .btn-delete-meal:hover {
            background: #c82333;
        }

        .meal-foods {
            padding: 1rem;
        }

        .meal-item.collapsed .meal-foods {
            display: none;
        }

        .meal-item.collapsed .meal-footer {
            display: none;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .food-item:last-child {
            border-bottom: none;
        }

        .food-name {
            font-weight: 500;
            color: #333;
        }

        .food-details {
            color: #666;
            font-size: 0.9rem;
        }

        .add-meal-bottom {
            text-align: center;
            padding: 1rem 0;
        }

        .btn-add-meal-bottom {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-meal-bottom:hover {
            background: #218838;
        }

        .meal-foods.empty {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .empty-meal-message {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-meal-message span {
            display: block;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .btn-add-food {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .btn-add-food:hover {
            background: #138496;
        }

        .meal-footer {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            justify-content: center;
        }

        .meal-action-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .meal-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-delete-meal-footer {
            background-color: #dc3545;
            color: white;
        }

        .btn-delete-meal-footer:hover {
            background-color: #c82333;
        }

        .btn-add-meal-below {
            background-color: #007bff;
            color: white;
        }

        .btn-add-meal-below:hover {
            background-color: #0056b3;
        }

        .btn-save-meal {
            background-color: #28a745;
            color: white;
        }

        .btn-save-meal:hover {
            background-color: #218838;
        }

        /* Add notes prompt styles */
        .add-notes-prompt {
            margin-bottom: 2rem;
            text-align: center;
        }

        .btn-add-notes {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-notes:hover {
            background: #218838;
        }

        /* Notes section styles */
        .notes-section {
            margin-bottom: 2rem;
        }

        .notes-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notes-header:hover {
            background: #e9ecef;
        }

        .notes-item.collapsed .notes-header {
            border-bottom: none;
        }

        .notes-info {
            flex: 1;
        }

        .notes-title {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        .notes-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit-notes {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-edit-notes:hover {
            background: #545b62;
        }

        .notes-content {
            padding: 1rem;
        }

        .notes-item.collapsed .notes-content {
            display: none;
        }

        .notes-display {
            line-height: 1.6;
            white-space: pre-wrap;
            min-height: 1.5rem;
        }

        .notes-display em {
            color: #666;
            font-style: italic;
        }

        .notes-edit-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        .notes-edit-form textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .notes-form-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .notes-form-actions .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .notes-form-actions .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .notes-form-actions .btn-primary:hover {
            background-color: #0056b3;
        }

        .notes-form-actions .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .notes-form-actions .btn-secondary:hover {
            background-color: #545b62;
        }

        /* Exercise section styles */
        .add-exercise-prompt {
            margin-bottom: 2rem;
            text-align: center;
        }

        .btn-add-exercise {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-exercise:hover {
            background: #138496;
        }

        .exercise-section {
            margin-bottom: 2rem;
        }

        .exercise-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .exercise-header:hover {
            background: #e9ecef;
        }

        .exercise-item.collapsed .exercise-header {
            border-bottom: none;
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-title {
            margin: 0 0 0.25rem 0;
            font-size: 1.2rem;
            color: #333;
        }

        .exercise-summary {
            font-size: 0.9rem;
            color: #666;
        }

        .exercise-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-add-exercise-inline {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-exercise-inline:hover {
            background: #138496;
        }

        .exercise-content {
            padding: 1rem;
        }

        .exercise-item.collapsed .exercise-content {
            display: none;
        }

        .exercise-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .exercise-list-item:last-child {
            margin-bottom: 0;
        }

        .exercise-details {
            flex: 1;
        }

        .exercise-type {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .exercise-kcal {
            color: #666;
            font-size: 0.9rem;
        }

        .exercise-item-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-delete-exercise {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }

        .btn-delete-exercise:hover {
            background: #c82333;
        }

        .exercise-form {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .exercise-form .form-group {
            margin-bottom: 1rem;
        }

        .exercise-form .form-group:last-of-type {
            margin-bottom: 1.5rem;
        }

        .exercise-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .exercise-form select,
        .exercise-form input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .exercise-form select:focus,
        .exercise-form input:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }

        .exercise-form-actions {
            display: flex;
            gap: 0.5rem;
        }

        .exercise-form-actions .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .exercise-form-actions .btn-primary {
            background-color: #17a2b8;
            color: white;
        }

        .exercise-form-actions .btn-primary:hover {
            background-color: #138496;
        }

        .exercise-form-actions .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .exercise-form-actions .btn-secondary:hover {
            background-color: #545b62;
        }

        @media (max-width: 768px) {
            #page-container {
                padding: 0 1rem;
            }

            .summary-panel {
                padding: 1.5rem;
            }

            .date-display {
                font-size: 1.5rem;
            }

            .calorie-summary {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .calorie-item {
                justify-content: space-between;
            }

            .date-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .header-actions {
                flex-direction: row;
                justify-content: space-between;
                gap: 0.5rem;
            }

            .header-actions button {
                flex: 1;
                font-size: 0.8rem;
                padding: 0.5rem;
            }

            .header-section {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .food-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div id="page-container">
        <div id="navbar-container"></div>
        
        <div class="summary-panel">
            <div class="summary-info">
                <div class="date-header">
                    <h1 class="date-display" id="dateDisplay">Today</h1>
                    <a href="/progress.html" class="progress-link">View Progress →</a>
                </div>
                <div class="calorie-summary">
                    <div class="calorie-item">
                        <span class="calorie-label">Total:</span>
                        <span class="calorie-value" id="totalKcal">0</span>
                    </div>
                    <div class="calorie-item">
                        <span class="calorie-label">Goal:</span>
                        <span class="calorie-value" id="goalKcal">2000</span>
                    </div>
                    <div class="calorie-item">
                        <span class="calorie-label">Remaining:</span>
                        <span class="calorie-value" id="remainingKcal">2000</span>
                    </div>
                    <div class="calorie-item">
                        <span class="calorie-label">Deficit:</span>
                        <span class="calorie-value" id="deficitKcal">2400</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button id="prevDayBtn" class="btn btn-outline">← Previous Day</button>
                <button id="todayBtn" class="btn btn-secondary">Today</button>
                <button id="nextDayBtn" class="btn btn-outline">Next Day →</button>
            </div>
        </div>

        <div class="notes-section">
            <div class="notes-item collapsed" id="notesItem">
                <div class="notes-header" onclick="toggleNotes()">
                    <div class="notes-info">
                        <h3 class="notes-title">Notes</h3>
                    </div>
                    <div class="notes-actions">
                        <button class="btn-edit-notes" onclick="event.stopPropagation(); editNotes()" title="Edit notes">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="notes-content">
                    <div class="notes-display" id="notesDisplay">
                        <em>No notes for this day</em>
                    </div>
                    <div class="notes-edit-form" id="notesEditForm" style="display: none;">
                        <textarea id="notesTextarea" placeholder="Enter your notes for this day..." rows="4"></textarea>
                        <div class="notes-form-actions">
                            <button class="btn btn-primary" onclick="saveNotes()">Save</button>
                            <button class="btn btn-secondary" onclick="cancelEditNotes()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="exercise-section" id="exerciseSection" style="display: none;">
            <div class="exercise-item" id="exerciseItem">
                <div class="exercise-header" onclick="toggleExercise()">
                    <div class="exercise-info">
                        <h3 class="exercise-title">Exercise Sessions</h3>
                        <div class="exercise-summary" id="exerciseSummary">No exercises logged</div>
                    </div>
                    <div class="exercise-actions">
                        <button class="btn-add-exercise-inline" onclick="event.stopPropagation(); showExerciseForm()" title="Add exercise">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="exercise-content">
                    <div class="exercise-list" id="exerciseList">
                        <!-- Exercise sessions will be populated here -->
                    </div>
                    <div class="exercise-form" id="exerciseForm" style="display: none;">
                        <div class="form-group">
                            <label for="exerciseType">Exercise Type:</label>
                            <select id="exerciseType" required>
                                <option value="">Select exercise type...</option>
                                <option value="BodyPump">BodyPump</option>
                                <option value="Cardio">Cardio</option>
                                <option value="Cycle">Cycle</option>
                                <option value="Walk">Walk</option>
                                <option value="Workout">Workout</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exerciseKcal">Calories Burned:</label>
                            <input type="number" id="exerciseKcal" min="0" placeholder="Enter calories burned" required>
                        </div>
                        <div class="exercise-form-actions">
                            <button class="btn btn-primary" onclick="saveExercise()">Save</button>
                            <button class="btn btn-secondary" onclick="cancelExerciseForm()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <ul id="dayList" class="day-list">
        </ul>

        <div class="add-notes-prompt" id="addNotesPrompt" style="display: none;">
            <button class="btn-add-notes" onclick="showNotesForEditing()">+ Add Notes</button>
        </div>

        <div class="add-exercise-prompt" id="addExercisePrompt">
            <button class="btn-add-exercise" onclick="showExerciseForm()">+ Add Exercise</button>
        </div>
    </div>

    <script>
        let currentDate = null;
        let isTodayMode = false; // Track if we're in "day=today" mode
        let appConfig = { goals: { daily_kcal: 2000, tdee: 2400 } }; // Default config

        $(document).ready(function() {
            loadNavbar();
            loadAppConfig();

            // We'll restore expanded meals state after loading the day

            // Get date from query parameter, localStorage, or use today
            const urlParams = new URLSearchParams(window.location.search);
            const dayParam = urlParams.get('day');
            const dateParam = urlParams.get('yyyymmdd');
            
            // Special case: day=today displays current day without redirecting
            if (dayParam === 'today') {
                const today = new Date();
                currentDate = parseInt(formatDateToYYYYMMDD(today));
                isTodayMode = true;
            } else if (dateParam && /^\d{8}$/.test(dateParam)) {
                currentDate = parseInt(dateParam);
                isTodayMode = false;
            } else {
                // Try to restore from localStorage
                const savedDate = localStorage.getItem('dayPage_currentDate');
                if (savedDate && /^\d{8}$/.test(savedDate)) {
                    currentDate = parseInt(savedDate);
                } else {
                    // Use today's date if no valid saved date
                    const today = new Date();
                    currentDate = parseInt(formatDateToYYYYMMDD(today));
                }
                isTodayMode = false;
            }

            loadDay(currentDate);

            // Set up navigation buttons
            $('#prevDayBtn').click(() => navigateDay(-1));
            $('#nextDayBtn').click(() => navigateDay(1));
            $('#todayBtn').click(() => navigateToToday());

            // Set up action buttons
            $('#addFoodBtn').click(() => addFoodToDay());
            $('#addMealBtn').click(() => addMealToDay());

            // Save state when leaving the page
            $(window).on('beforeunload', function() {
                savePageState();
            });
        });

        function loadNavbar() {
            $.get('/_navbar.html', function(data) {
                $('#navbar-container').html(data);
                // Navbar will automatically set active tab based on current page
            }).fail(function() {
                console.error('Failed to load navbar');
            });
        }

        function loadAppConfig() {
            $.get('/day/config', function(data) {
                appConfig = data;
                console.log('Loaded app config:', appConfig);
            }).fail(function() {
                console.warn('Failed to load app config, using defaults');
            });
        }

        function loadDay(yyyymmdd) {
            currentDate = yyyymmdd;
            
            // Save current date to localStorage
            localStorage.setItem('dayPage_currentDate', yyyymmdd.toString());
            
            // Update date display
            const dateStr = formatDateForDisplay(yyyymmdd);
            $('#dateDisplay').text(dateStr);
            document.title = `Food Tracker - ${dateStr}`;
            
            // Update URL without refreshing page (unless in "today" mode)
            if (!isTodayMode) {
                const newUrl = `${window.location.pathname}?yyyymmdd=${yyyymmdd}`;
                window.history.pushState({}, '', newUrl);
            }

            // Restore expanded meals state for this specific date
            const savedExpandedMeals = localStorage.getItem(`dayPage_expandedMeals_${yyyymmdd}`);
            if (savedExpandedMeals) {
                expandedMeals = new Set(JSON.parse(savedExpandedMeals));
            } else {
                expandedMeals = new Set();
            }

            $.ajax({
                url: `/day/${yyyymmdd}`,
                method: 'GET',
                success: function(day) {
                    console.log('Day loaded successfully:', day);
                    displayDay(day);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching day:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });
                    
                    if (xhr.status === 404) {
                        // Day doesn't exist, display empty day with option to add meals
                        console.log('Day not found (404), creating empty day display');
                        const emptyDay = {
                            yyyymmdd: yyyymmdd,
                            meals: [],
                            goal_kcal: 2000
                        };
                        displayDay(emptyDay);
                    } else {
                        console.error('Non-404 error, showing error message');
                        $('#dayList').html(`<li>Error loading day entry: ${xhr.status} ${xhr.statusText}</li>`);
                    }
                }
            });
        }

        // Store current day data globally for meal toggling
        let currentDayData = null;
        
        // Store expanded meal states
        let expandedMeals = new Set();

        function displayDay(day) {
            console.log('Displaying day:', day); // Debug log
            
            // Store the day data for meal toggling
            currentDayData = day;
            
            // Update summary panel
            updateSummaryPanel(day);
            
            // Load notes for this day
            loadNotesForDay(day);
            
            // Load exercises for this day
            loadExercisesForDay(day);
            
            if (!day || !day.meals || day.meals.length === 0) {
                $('#dayList').html(`
                    <div class="empty-day">
                        <p>No meals recorded for this day</p>
                        <button class="btn-add-meal-bottom" onclick="addMealAfter(-1)">+ Add First Meal</button>
                    </div>
                `);
                return;
            }

            let html = '';
            day.meals.forEach((meal, index) => {
                console.log(`Processing meal ${index}:`, meal); // Debug log
                const totalKcal = meal.foods ? meal.foods.reduce((sum, food) => sum + food.kcal, 0) : 0;
                const foodCount = meal.foods ? meal.foods.length : 0;
                
                // Create food summary
                let foodSummary = '';
                if (foodCount === 0) {
                    foodSummary = 'No foods added';
                } else if (foodCount <= 3) {
                    // Show individual food names for small lists
                    foodSummary = meal.foods.map(food => food.title).join(', ');
                } else {
                    // Show first 2 foods + count for longer lists
                    const firstTwo = meal.foods.slice(0, 2).map(food => food.title).join(', ');
                    foodSummary = `${firstTwo} + ${foodCount - 2} more`;
                }
                
                html += `
                    <div class="meal-item collapsed" data-meal-index="${index}">
                        <div class="meal-header" onclick="toggleMeal(${index})">
                            <div class="meal-info">
                                <h3 class="meal-title">${escapeHtml(meal.title)} - ${totalKcal} kcal</h3>
                            </div>
                            <div class="meal-actions">
                                <button class="btn-add-food-to-meal" onclick="event.stopPropagation(); addFoodToMeal(${index})" title="Add Food to Meal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                    </svg>
                                </button>
                                <button class="btn-add-meal-to-meal" onclick="event.stopPropagation(); addMealToExisting(${index})" title="Add Saved Meal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journal-plus" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8 5.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 .5-.5"/>
                                        <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2"/>
                                        <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z"/>
                                    </svg>
                                </button>
                                <button class="btn-edit-meal" onclick="event.stopPropagation(); editMeal(${index})" title="Edit meal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        ${meal.foods && meal.foods.length > 0 ? `
                            <div class="meal-foods">
                                ${meal.foods.map(food => `
                                    <div class="food-item">
                                        <span class="food-name">${escapeHtml(food.title)}</span>
                                        <span class="food-details">${food.kcal} kcal • ${food.weight}g</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="meal-foods empty">
                                <div class="empty-meal-message">
                                    <span>No foods added to this meal yet</span>
                                </div>
                            </div>
                        `}
                        <div class="meal-footer">
                            <button class="meal-action-btn btn-delete-meal-footer" onclick="deleteMeal(${index})" title="Delete meal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                </svg>
                            </button>
                            <button class="meal-action-btn btn-add-meal-below" onclick="addMealAfter(${index})" title="Add meal below">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar2-plus" viewBox="0 0 16 16">
                                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z"/>
                                    <path d="M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5zM8 8a.5.5 0 0 1 .5.5V10H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V11H6a.5.5 0 0 1 0-1h1.5V8.5A.5.5 0 0 1 8 8"/>
                                </svg>
                            </button>
                            <button class="meal-action-btn btn-save-meal" onclick="saveMealTemplate(${index})" title="Save this meal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                                    <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add a final + button to add a meal at the end
            /*
            html += `
                <div class="add-meal-bottom">
                    <button class="btn-add-meal-bottom" onclick="addMealAfter(${day.meals.length - 1})">+ Add Meal</button>
                </div>
            `;
            */
            
            $('#dayList').html(html);
            
            // Restore expanded states after rendering
            restoreExpandedStates();
        }

        function navigateDay(direction) {
            isTodayMode = false; // Exit "today mode" when navigating
            const date = parseYYYYMMDD(currentDate);
            date.setDate(date.getDate() + direction);
            const newYYYYMMDD = parseInt(formatDateToYYYYMMDD(date));
            loadDay(newYYYYMMDD);
        }

        function navigateToToday() {
            isTodayMode = false; // Exit "today mode" when clicking "Today" button
            const today = new Date();
            const todayYYYYMMDD = parseInt(formatDateToYYYYMMDD(today));
            loadDay(todayYYYYMMDD);
        }

        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function parseYYYYMMDD(yyyymmdd) {
            const str = yyyymmdd.toString();
            const year = parseInt(str.substring(0, 4));
            const month = parseInt(str.substring(4, 6)) - 1; // Month is 0-indexed
            const day = parseInt(str.substring(6, 8));
            return new Date(year, month, day);
        }

        function formatDateForDisplay(yyyymmdd) {
            const date = parseYYYYMMDD(yyyymmdd);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Check if it's today, yesterday, or tomorrow
            if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(today)) {
                return "Today";
            } else if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(yesterday)) {
                return "Yesterday";
            } else if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(tomorrow)) {
                return "Tomorrow";
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
        }

        function addMealAfter(index) {
            const mealName = prompt('Enter meal name:');
            if (!mealName || !mealName.trim()) {
                return;
            }

            // Add the new meal to the day
            $.ajax({
                url: `/day/${currentDate}/meals`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    title: mealName.trim(),
                    insertAfterIndex: index >= 0 ? index : undefined
                }),
                success: function(updatedDay) {
                    // When adding a meal, we need to adjust expanded meal indices
                    // since a new meal was inserted
                    const newExpandedMeals = new Set();
                    expandedMeals.forEach(expandedIndex => {
                        if (expandedIndex > index) {
                            // Shift indices after the insertion point
                            newExpandedMeals.add(expandedIndex + 1);
                        } else {
                            newExpandedMeals.add(expandedIndex);
                        }
                    });
                    expandedMeals = newExpandedMeals;
                    
                    displayDay(updatedDay);
                },
                error: function(xhr, status, error) {
                    console.error('Error adding meal:', error);
                    alert('Error adding meal: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function editMeal(index) {
            // Redirect to meal editing page
            window.location.href = `/edit_meal.html?day=${currentDate}&meal=${index}`;
        }

        function addFoodToMeal(mealIndex) {
            // Store the target meal index for when we return from food selection
            localStorage.setItem('targetMealIndex', mealIndex);
            window.location.href = 'add_food.html?returnTo=day&dayId=' + currentDate;
        }

        function addMealToExisting(mealIndex) {
            // Store the target meal index for when we return from meal selection
            localStorage.setItem('targetMealIndex', mealIndex);
            window.location.href = 'add_meal.html?returnTo=day&dayId=' + currentDate;
        }

        function deleteMeal(index) {
            if (!confirm('Are you sure you want to delete this meal? This action cannot be undone.')) {
                return;
            }

            // Get the current day data
            $.ajax({
                url: `/day/${currentDate}`,
                method: 'GET',
                success: function(day) {
                    if (!day.meals || index >= day.meals.length) {
                        alert('Meal not found');
                        return;
                    }

                    // Remove the meal from the meals array
                    const updatedMeals = [...day.meals];
                    updatedMeals.splice(index, 1);

                    // Update the day with the modified meals array
                    $.ajax({
                        url: `/day/${currentDate}`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify({ meals: updatedMeals }),
                        success: function(response) {
                            console.log('Meal deleted successfully');
                            
                            // When deleting a meal, we need to adjust expanded meal indices
                            const newExpandedMeals = new Set();
                            expandedMeals.forEach(expandedIndex => {
                                if (expandedIndex < index) {
                                    // Keep indices before the deleted meal
                                    newExpandedMeals.add(expandedIndex);
                                } else if (expandedIndex > index) {
                                    // Shift indices after the deleted meal down by 1
                                    newExpandedMeals.add(expandedIndex - 1);
                                }
                                // Skip the deleted meal index (expandedIndex === index)
                            });
                            expandedMeals = newExpandedMeals;
                            
                            // Reload the day view to show the updated meals
                            loadDay(currentDate);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error deleting meal:', error);
                            alert('Error deleting meal: ' + (xhr.responseJSON?.error || 'Unknown error'));
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading day:', error);
                    alert('Error loading day: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function addFoodToMeal(mealIndex) {
            // Redirect to food.html with context about adding to a specific meal on a specific day
            const queryParams = new URLSearchParams({
                action: 'add-to-meal',
                day: currentDate.toString(),
                meal: mealIndex.toString()
            });
            window.location.href = `food.html?${queryParams.toString()}`;
        }

        function addMealToExisting(mealIndex) {
            // Redirect to meals.html to select a saved meal to add to this specific day meal
            window.location.href = `meals.html?day=${currentDate}&meal=${mealIndex}`;
        }

        function toggleMeal(index) {
            const mealItem = $(`.meal-item[data-meal-index="${index}"]`);
            const isCollapsed = mealItem.hasClass('collapsed');
            
            if (isCollapsed) {
                // Expand the meal - show detailed view
                mealItem.removeClass('collapsed');
                expandedMeals.add(index);
                
                // Update meal header to show detailed summary
                const mealInfo = mealItem.find('.meal-info');
                const meal = getCurrentMealData(index);
                
                if (meal) {
                    const totalKcal = meal.foods ? meal.foods.reduce((sum, food) => sum + food.kcal, 0) : 0;
                    const foodCount = meal.foods ? meal.foods.length : 0;
                    
                    // Create food summary
                    let foodSummary = '';
                    if (foodCount === 0) {
                        foodSummary = 'No foods added';
                    } else if (foodCount <= 3) {
                        foodSummary = meal.foods.map(food => food.title).join(', ');
                    } else {
                        const firstTwo = meal.foods.slice(0, 2).map(food => food.title).join(', ');
                        foodSummary = `${firstTwo} + ${foodCount - 2} more`;
                    }
                    
                    mealInfo.html(`
                        <h3 class="meal-title">${escapeHtml(meal.title)}</h3>
                        <div class="meal-summary">
                            <span class="food-summary">${escapeHtml(foodSummary)}</span>
                            <span class="calories-summary">${totalKcal} kcal</span>
                        </div>
                    `);
                }
            } else {
                // Collapse the meal - show simple view
                mealItem.addClass('collapsed');
                expandedMeals.delete(index);
                
                // Update meal header to show simple view
                const mealInfo = mealItem.find('.meal-info');
                const meal = getCurrentMealData(index);
                
                if (meal) {
                    const totalKcal = meal.foods ? meal.foods.reduce((sum, food) => sum + food.kcal, 0) : 0;
                    mealInfo.html(`
                        <h3 class="meal-title">${escapeHtml(meal.title)} - ${totalKcal} kcal</h3>
                    `);
                }
            }
            
            // Save expanded states to localStorage
            savePageState();
        }

        function getCurrentMealData(index) {
            if (currentDayData && currentDayData.meals && currentDayData.meals[index]) {
                return currentDayData.meals[index];
            }
            return null;
        }

        function updateSummaryPanel(day) {
            // Calculate total calories consumed
            let totalConsumed = 0;
            if (day && day.meals) {
                totalConsumed = day.meals.reduce((dayTotal, meal) => {
                    if (meal.foods) {
                        return dayTotal + meal.foods.reduce((mealTotal, food) => mealTotal + food.kcal, 0);
                    }
                    return dayTotal;
                }, 0);
            }
            
            // Get goal calories (default to 2000 if not set)
            const goalKcal = day?.goal_kcal || 2000;
            
            // Calculate remaining (goal - total)
            const remainingKcal = goalKcal - totalConsumed;
            
            // Calculate total exercise calories burned
            let totalExerciseKcal = 0;
            if (day && day.exercise_sessions) {
                totalExerciseKcal = day.exercise_sessions.reduce((total, exercise) => total + exercise.kcal, 0);
            }
            
            // Calculate adjusted TDEE with exercise
            const tdee = appConfig.goals.tdee || 2400;
            let adjustedTdee = tdee;
            
            // Only adjust TDEE if there are actual exercises logged
            if (totalExerciseKcal > 0) {
                const exerciseAdjustment = totalExerciseKcal - (tdee / 24);
                adjustedTdee = tdee + exerciseAdjustment;
            }
            
            // Calculate deficit (adjusted TDEE - total consumed)
            const deficitKcal = Math.round(adjustedTdee - totalConsumed);
            
            // Update the display
            $('#totalKcal').text(totalConsumed);
            $('#goalKcal').text(goalKcal);
            $('#remainingKcal').text(remainingKcal);
            $('#deficitKcal').text(deficitKcal);
            
            // Style the remaining calories based on whether it's positive or negative
            const remainingElement = $('#remainingKcal');
            if (remainingKcal < 0) {
                remainingElement.css('color', '#ff6b6b');
            } else if (remainingKcal < 200) {
                remainingElement.css('color', '#ffa726');
            } else {
                remainingElement.css('color', 'inherit');
            }
            
            // Style the deficit calories
            const deficitElement = $('#deficitKcal');
            if (deficitKcal < 0) {
                deficitElement.css('color', '#ff6b6b'); // Red for surplus (negative deficit)
            } else if (deficitKcal > 500) {
                deficitElement.css('color', '#28a745'); // Green for good deficit
            } else {
                deficitElement.css('color', 'inherit');
            }
        }

        function savePageState() {
            // Save current date and expanded meals to localStorage
            if (currentDate) {
                localStorage.setItem('dayPage_currentDate', currentDate.toString());
                localStorage.setItem(`dayPage_expandedMeals_${currentDate}`, JSON.stringify(Array.from(expandedMeals)));
            }
        }

        function restoreExpandedStates() {
            // Apply expanded states to rendered meals
            expandedMeals.forEach(index => {
                const mealItem = $(`.meal-item[data-meal-index="${index}"]`);
                if (mealItem.length > 0) {
                    // Remove collapsed class and update header
                    mealItem.removeClass('collapsed');
                    
                    const mealInfo = mealItem.find('.meal-info');
                    const meal = getCurrentMealData(index);
                    
                    if (meal) {
                        const totalKcal = meal.foods ? meal.foods.reduce((sum, food) => sum + food.kcal, 0) : 0;
                        const foodCount = meal.foods ? meal.foods.length : 0;
                        
                        // Create food summary
                        let foodSummary = '';
                        if (foodCount === 0) {
                            foodSummary = 'No foods added';
                        } else if (foodCount <= 3) {
                            foodSummary = meal.foods.map(food => food.title).join(', ');
                        } else {
                            const firstTwo = meal.foods.slice(0, 2).map(food => food.title).join(', ');
                            foodSummary = `${firstTwo} + ${foodCount - 2} more`;
                        }
                        
                        mealInfo.html(`
                            <h3 class="meal-title">${escapeHtml(meal.title)}</h3>
                            <div class="meal-summary">
                                <span class="food-summary">${escapeHtml(foodSummary)}</span>
                                <span class="calories-summary">${totalKcal} kcal</span>
                            </div>
                        `);
                    }
                }
            });
        }

        function addFoodToDay() {
            // Redirect to food.html with context about adding to current day
            const queryParams = new URLSearchParams({
                action: 'add-to-day',
                day: currentDate.toString()
            });
            window.location.href = `food.html?${queryParams.toString()}`;
        }

        function addMealToDay() {
            // Redirect to meals.html to select a saved meal to add to this day
            window.location.href = `meals.html?day=${currentDate}`;
        }

        function saveMealTemplate(mealIndex) {
            const meal = getCurrentMealData(mealIndex);
            if (!meal) {
                alert('Meal not found');
                return;
            }

            // Create a query string to pass the meal data to edit_meal.html
            const queryParams = new URLSearchParams({
                action: 'save-as-template',
                day: currentDate.toString(),
                meal: mealIndex.toString()
            });
            
            // Redirect to edit_meal.html in "save as template" mode
            window.location.href = `edit_meal.html?${queryParams.toString()}`;
        }

        // Notes functionality
        let notesExpanded = false;

        function toggleNotes() {
            const notesItem = $('#notesItem');
            const isCollapsed = notesItem.hasClass('collapsed');
            
            if (isCollapsed) {
                notesItem.removeClass('collapsed');
                notesExpanded = true;
            } else {
                notesItem.addClass('collapsed');
                notesExpanded = false;
            }
            
            // Save expanded state to localStorage
            localStorage.setItem(`dayPage_notesExpanded_${currentDate}`, notesExpanded.toString());
        }

        function editNotes() {
            $('#notesDisplay').hide();
            $('#notesEditForm').show();
            $('#notesTextarea').focus();
        }

        function cancelEditNotes() {
            $('#notesEditForm').hide();
            
            // Check if current day actually has notes
            const currentDayHasNotes = currentDayData && currentDayData.notes && currentDayData.notes.trim();
            
            if (currentDayHasNotes) {
                // Show the notes display with current day's notes
                $('#notesDisplay').show();
            } else {
                // Hide notes section and show add prompt since this day has no notes
                $('.notes-section').hide();
                $('#addNotesPrompt').show();
            }
        }

        function saveNotes() {
            const notes = $('#notesTextarea').val().trim();
            
            // Update the day document with notes
            $.ajax({
                url: `/day/${currentDate}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ notes: notes || null }),
                success: function(response) {
                    console.log('Notes saved successfully');
                    updateNotesDisplay(notes);
                    cancelEditNotes();
                    
                    // Handle visibility after saving
                    const notesSection = $('.notes-section');
                    const addNotesPrompt = $('#addNotesPrompt');
                    if (notes) {
                        // Show section, hide prompt, and keep expanded after saving
                        notesSection.show();
                        addNotesPrompt.hide();
                        $('#notesItem').removeClass('collapsed');
                        notesExpanded = true;
                        localStorage.setItem(`dayPage_notesExpanded_${currentDate}`, 'true');
                    } else {
                        // Hide section and show prompt if notes were cleared
                        notesSection.hide();
                        addNotesPrompt.show();
                        notesExpanded = false;
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving notes:', error);
                    alert('Error saving notes: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function updateNotesDisplay(notes) {
            const notesDisplay = $('#notesDisplay');
            if (notes && notes.trim()) {
                notesDisplay.html(escapeHtml(notes).replace(/\n/g, '<br>'));
            } else {
                notesDisplay.html('<em>No notes for this day</em>');
            }
        }

        function loadNotesForDay(day) {
            const hasNotes = day.notes && day.notes.trim();
            const notesSection = $('.notes-section');
            const addNotesPrompt = $('#addNotesPrompt');
            const notesItem = $('#notesItem');
            
            if (hasNotes) {
                // Show notes section and hide add prompt
                notesSection.show();
                addNotesPrompt.hide();
                updateNotesDisplay(day.notes);
                
                // Set textarea value for editing
                $('#notesTextarea').val(day.notes);
                
                // Show expanded by default when there are notes, but allow saved preference to override
                const savedNotesExpanded = localStorage.getItem(`dayPage_notesExpanded_${currentDate}`);
                if (savedNotesExpanded === 'false') {
                    notesItem.addClass('collapsed');
                    notesExpanded = false;
                } else {
                    // Default to expanded when there are notes
                    notesItem.removeClass('collapsed');
                    notesExpanded = true;
                }
            } else {
                // Hide notes section and show add prompt when there are no notes
                notesSection.hide();
                addNotesPrompt.show();
                notesExpanded = false;
            }
        }

        function showNotesForEditing() {
            // Show notes section, hide add prompt, and open in edit mode
            $('.notes-section').show();
            $('#addNotesPrompt').hide();
            $('#notesItem').removeClass('collapsed');
            $('#notesTextarea').val('');
            editNotes();
            notesExpanded = true;
        }

        // Exercise functionality
        let exerciseExpanded = false;
        let editingExerciseId = null;

        function toggleExercise() {
            const exerciseItem = $('#exerciseItem');
            const isCollapsed = exerciseItem.hasClass('collapsed');
            
            if (isCollapsed) {
                exerciseItem.removeClass('collapsed');
                exerciseExpanded = true;
            } else {
                exerciseItem.addClass('collapsed');
                exerciseExpanded = false;
            }
            
            // Save expanded state to localStorage
            localStorage.setItem(`dayPage_exerciseExpanded_${currentDate}`, exerciseExpanded.toString());
        }

        function showExerciseForm(exerciseData = null) {
            // Show exercise section if hidden
            $('#exerciseSection').show();
            $('#addExercisePrompt').hide();
            $('#exerciseItem').removeClass('collapsed');
            
            // Reset form
            $('#exerciseType').val('');
            $('#exerciseKcal').val('');
            editingExerciseId = null;
            
            // If editing, populate form
            if (exerciseData) {
                $('#exerciseType').val(exerciseData.type);
                $('#exerciseKcal').val(exerciseData.kcal);
                editingExerciseId = exerciseData.id;
            }
            
            $('#exerciseForm').show();
            exerciseExpanded = true;
        }

        function cancelExerciseForm() {
            $('#exerciseForm').hide();
            editingExerciseId = null;
            
            // Check if there are any exercises, if not hide section
            const hasExercises = currentDayData && currentDayData.exercise_sessions && currentDayData.exercise_sessions.length > 0;
            if (!hasExercises) {
                $('#exerciseSection').hide();
                $('#addExercisePrompt').show();
            }
        }

        function saveExercise() {
            const type = $('#exerciseType').val().trim();
            const kcal = parseInt($('#exerciseKcal').val());
            
            if (!type || !kcal || kcal <= 0) {
                alert('Please fill in all fields with valid values.');
                return;
            }
            
            // Get current exercise sessions or initialize empty array
            const currentExercises = currentDayData?.exercise_sessions || [];
            
            if (editingExerciseId !== null) {
                // Update existing exercise
                currentExercises[editingExerciseId] = { type, kcal };
            } else {
                // Add new exercise
                currentExercises.push({ type, kcal });
            }
            
            // Update the day document with exercise sessions
            $.ajax({
                url: `/day/${currentDate}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ exercise_sessions: currentExercises }),
                success: function(response) {
                    console.log('Exercise saved successfully');
                    // Update current day data
                    currentDayData.exercise_sessions = currentExercises;
                    updateExerciseDisplay();
                    updateSummaryPanel(currentDayData); // Recalculate deficit with exercises
                    cancelExerciseForm();
                },
                error: function(xhr, status, error) {
                    console.error('Error saving exercise:', error);
                    alert('Error saving exercise: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function deleteExercise(index) {
            if (!confirm('Are you sure you want to delete this exercise?')) {
                return;
            }
            
            const currentExercises = currentDayData?.exercise_sessions || [];
            currentExercises.splice(index, 1);
            
            // Update the day document
            $.ajax({
                url: `/day/${currentDate}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ exercise_sessions: currentExercises }),
                success: function(response) {
                    console.log('Exercise deleted successfully');
                    currentDayData.exercise_sessions = currentExercises;
                    updateExerciseDisplay();
                    updateSummaryPanel(currentDayData); // Recalculate deficit
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting exercise:', error);
                    alert('Error deleting exercise: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function updateExerciseDisplay() {
            const exercises = currentDayData?.exercise_sessions || [];
            const exerciseSection = $('#exerciseSection');
            const addExercisePrompt = $('#addExercisePrompt');
            const exerciseList = $('#exerciseList');
            const exerciseSummary = $('#exerciseSummary');
            
            if (exercises.length > 0) {
                // Show exercise section
                exerciseSection.show();
                addExercisePrompt.hide();
                
                // Update summary
                const totalKcal = exercises.reduce((sum, ex) => sum + ex.kcal, 0);
                const exerciseCount = exercises.length;
                exerciseSummary.text(`${exerciseCount} session${exerciseCount !== 1 ? 's' : ''} • ${totalKcal} kcal burned`);
                
                // Update exercise list
                let html = '';
                exercises.forEach((exercise, index) => {
                    html += `
                        <div class="exercise-list-item">
                            <div class="exercise-details">
                                <div class="exercise-type">${escapeHtml(exercise.type)}</div>
                                <div class="exercise-kcal">${exercise.kcal} kcal burned</div>
                            </div>
                            <div class="exercise-item-actions">
                                <button class="btn-delete-exercise" onclick="deleteExercise(${index})" title="Delete exercise">×</button>
                            </div>
                        </div>
                    `;
                });
                exerciseList.html(html);
                
                // Restore expanded state
                const savedExerciseExpanded = localStorage.getItem(`dayPage_exerciseExpanded_${currentDate}`);
                if (savedExerciseExpanded === 'false') {
                    $('#exerciseItem').addClass('collapsed');
                    exerciseExpanded = false;
                } else {
                    $('#exerciseItem').removeClass('collapsed');
                    exerciseExpanded = true;
                }
            } else {
                // Hide exercise section and show add prompt
                exerciseSection.hide();
                addExercisePrompt.show();
            }
        }

        function loadExercisesForDay(day) {
            updateExerciseDisplay();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
