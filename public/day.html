<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <title>Food Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/tracker.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* Page container styling handled by tracker.css */        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        #dayList {
            padding: 0;
            margin: 0;
        }

        .empty-day {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-style: italic;
        }

        .meal-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .meal-info {
            flex: 1;
        }

        .meal-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            color: #333;
            text-transform: capitalize;
        }

        .meal-summary {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .food-summary {
            color: #666;
            font-size: 0.9rem;
        }

        .calories-summary {
            color: #28a745;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .meal-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-add-meal, .btn-edit-meal, .btn-delete-meal {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-meal:hover {
            background: #0056b3;
        }

        .btn-edit-meal {
            background: #6c757d;
        }

        .btn-edit-meal:hover {
            background: #545b62;
        }

        .btn-delete-meal {
            background: #dc3545;
        }

        .btn-delete-meal:hover {
            background: #c82333;
        }

        .meal-foods {
            padding: 1rem;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .food-item:last-child {
            border-bottom: none;
        }

        .food-name {
            font-weight: 500;
            color: #333;
        }

        .food-details {
            color: #666;
            font-size: 0.9rem;
        }

        .add-meal-bottom {
            text-align: center;
            padding: 1rem 0;
        }

        .btn-add-meal-bottom {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-add-meal-bottom:hover {
            background: #218838;
        }

        .meal-foods.empty {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .empty-meal-message {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-meal-message span {
            display: block;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .btn-add-food {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .btn-add-food:hover {
            background: #138496;
        }

        .meal-footer {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            justify-content: center;
        }

        .meal-action-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .meal-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-add-food-meal {
            background-color: #4CAF50;
            color: white;
        }

        .btn-add-meal-meal {
            background-color: #2196F3;
            color: white;
        }

        @media (max-width: 768px) {
            #page-container {
                padding: 0 1rem;
            }

            .header-section {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .header-actions {
                justify-content: center;
            }

            .meal-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .meal-actions {
                justify-content: center;
            }

            .meal-summary {
                align-items: center;
                text-align: center;
            }

            .food-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div id="page-container">
        <div id="navbar-container"></div>
        
        <div class="header-section">
            <h1 id="pageTitle">Food Tracker</h1>
            <div class="header-actions">
                <button id="prevDayBtn" class="btn btn-outline">← Previous Day</button>
                <button id="todayBtn" class="btn btn-secondary">Today</button>
                <button id="nextDayBtn" class="btn btn-outline">Next Day →</button>
            </div>
        </div>

        <ul id="dayList" class="day-list">
        </ul>
    </div>

    <script>
        let currentDate = null;

        $(document).ready(function() {
            loadNavbar();

            // Get date from query parameter or use today
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('yyyymmdd');
            
            if (dateParam && /^\d{8}$/.test(dateParam)) {
                currentDate = parseInt(dateParam);
            } else {
                // Use today's date if no valid parameter provided
                const today = new Date();
                currentDate = parseInt(formatDateToYYYYMMDD(today));
            }

            loadDay(currentDate);

            // Set up navigation buttons
            $('#prevDayBtn').click(() => navigateDay(-1));
            $('#nextDayBtn').click(() => navigateDay(1));
            $('#todayBtn').click(() => navigateToToday());


        });

        function loadNavbar() {
            $.get('/_navbar.html', function(data) {
                $('#navbar-container').html(data);
                // Navbar will automatically set active tab based on current page
            }).fail(function() {
                console.error('Failed to load navbar');
            });
        }

        function loadDay(yyyymmdd) {
            currentDate = yyyymmdd;
            
            // Update page title
            const dateStr = formatDateForDisplay(yyyymmdd);
            $('#pageTitle').text(`Food Tracker - ${dateStr}`);
            
            // Update URL without refreshing page
            const newUrl = `${window.location.pathname}?yyyymmdd=${yyyymmdd}`;
            window.history.pushState({}, '', newUrl);

            $.ajax({
                url: `/day/${yyyymmdd}`,
                method: 'GET',
                success: function(day) {
                    displayDay(day);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching day:', error);
                    if (xhr.status === 404) {
                        $('#dayList').html('<li>No food tracking data for this day</li>');
                    } else {
                        $('#dayList').html('<li>Error loading day entry</li>');
                    }
                }
            });
        }

        function displayDay(day) {
            console.log('Displaying day:', day); // Debug log
            
            if (!day || !day.meals || day.meals.length === 0) {
                $('#dayList').html(`
                    <div class="empty-day">
                        <p>No meals recorded for this day</p>
                        <button class="btn-add-meal-bottom" onclick="addMealAfter(-1)">+ Add First Meal</button>
                    </div>
                `);
                return;
            }

            let html = '';
            day.meals.forEach((meal, index) => {
                console.log(`Processing meal ${index}:`, meal); // Debug log
                const totalKcal = meal.foods ? meal.foods.reduce((sum, food) => sum + food.kcal, 0) : 0;
                const foodCount = meal.foods ? meal.foods.length : 0;
                
                // Create food summary
                let foodSummary = '';
                if (foodCount === 0) {
                    foodSummary = 'No foods added';
                } else if (foodCount <= 3) {
                    // Show individual food names for small lists
                    foodSummary = meal.foods.map(food => food.title).join(', ');
                } else {
                    // Show first 2 foods + count for longer lists
                    const firstTwo = meal.foods.slice(0, 2).map(food => food.title).join(', ');
                    foodSummary = `${firstTwo} + ${foodCount - 2} more`;
                }
                
                html += `
                    <div class="meal-item" data-meal-index="${index}">
                        <div class="meal-header">
                            <div class="meal-info">
                                <h3 class="meal-title">${escapeHtml(meal.title)}</h3>
                                <div class="meal-summary">
                                    <span class="food-summary">${escapeHtml(foodSummary)}</span>
                                    <span class="calories-summary">${totalKcal} kcal</span>
                                </div>
                            </div>
                            <div class="meal-actions">
                                <button class="btn-add-meal" onclick="addMealAfter(${index})" title="Add meal below">+</button>
                                <button class="btn-edit-meal" onclick="editMeal(${index})" title="Edit meal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                                    </svg>
                                </button>
                                <button class="btn-delete-meal" onclick="deleteMeal(${index})" title="Delete meal">-</button>
                            </div>
                        </div>
                        ${meal.foods && meal.foods.length > 0 ? `
                            <div class="meal-foods">
                                ${meal.foods.map(food => `
                                    <div class="food-item">
                                        <span class="food-name">${escapeHtml(food.title)}</span>
                                        <span class="food-details">${food.kcal} kcal • ${food.weight}g</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="meal-foods empty">
                                <div class="empty-meal-message">
                                    <span>No foods added to this meal yet</span>
                                </div>
                            </div>
                        `}
                        <div class="meal-footer">
                            <button class="meal-action-btn btn-add-food-meal" onclick="addFoodToMeal(${index})">
                                Add Food
                            </button>
                            <button class="meal-action-btn btn-add-meal-meal" onclick="addMealToExisting(${index})">
                                Add Meal
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add a final + button to add a meal at the end
            /*
            html += `
                <div class="add-meal-bottom">
                    <button class="btn-add-meal-bottom" onclick="addMealAfter(${day.meals.length - 1})">+ Add Meal</button>
                </div>
            `;
            */
            
            $('#dayList').html(html);
        }

        function navigateDay(direction) {
            const date = parseYYYYMMDD(currentDate);
            date.setDate(date.getDate() + direction);
            const newYYYYMMDD = parseInt(formatDateToYYYYMMDD(date));
            loadDay(newYYYYMMDD);
        }

        function navigateToToday() {
            const today = new Date();
            const todayYYYYMMDD = parseInt(formatDateToYYYYMMDD(today));
            loadDay(todayYYYYMMDD);
        }

        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function parseYYYYMMDD(yyyymmdd) {
            const str = yyyymmdd.toString();
            const year = parseInt(str.substring(0, 4));
            const month = parseInt(str.substring(4, 6)) - 1; // Month is 0-indexed
            const day = parseInt(str.substring(6, 8));
            return new Date(year, month, day);
        }

        function formatDateForDisplay(yyyymmdd) {
            const date = parseYYYYMMDD(yyyymmdd);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Check if it's today, yesterday, or tomorrow
            if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(today)) {
                return "Today";
            } else if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(yesterday)) {
                return "Yesterday";
            } else if (formatDateToYYYYMMDD(date) === formatDateToYYYYMMDD(tomorrow)) {
                return "Tomorrow";
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }

        function addMealAfter(index) {
            const mealName = prompt('Enter meal name:');
            if (!mealName || !mealName.trim()) {
                return;
            }

            // Add the new meal to the day
            $.ajax({
                url: `/day/${currentDate}/meals`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    title: mealName.trim(),
                    insertAfterIndex: index >= 0 ? index : undefined
                }),
                success: function(updatedDay) {
                    displayDay(updatedDay);
                },
                error: function(xhr, status, error) {
                    console.error('Error adding meal:', error);
                    alert('Error adding meal: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function editMeal(index) {
            // Redirect to meal editing page
            window.location.href = `/edit_meal.html?day=${currentDate}&meal=${index}`;
        }

        function deleteMeal(index) {
            if (!confirm('Are you sure you want to delete this meal? This action cannot be undone.')) {
                return;
            }

            // Get the current day data
            $.ajax({
                url: `/day/${currentDate}`,
                method: 'GET',
                success: function(day) {
                    if (!day.meals || index >= day.meals.length) {
                        alert('Meal not found');
                        return;
                    }

                    // Remove the meal from the meals array
                    const updatedMeals = [...day.meals];
                    updatedMeals.splice(index, 1);

                    // Update the day with the modified meals array
                    $.ajax({
                        url: `/day/${currentDate}`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify({ meals: updatedMeals }),
                        success: function(response) {
                            console.log('Meal deleted successfully');
                            // Reload the day view to show the updated meals
                            loadDay(currentDate);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error deleting meal:', error);
                            alert('Error deleting meal: ' + (xhr.responseJSON?.error || 'Unknown error'));
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading day:', error);
                    alert('Error loading day: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function addFoodToMeal(mealIndex) {
            // Redirect to food.html with context about adding to a specific meal on a specific day
            const queryParams = new URLSearchParams({
                action: 'add-to-meal',
                day: currentDate.toString(),
                meal: mealIndex.toString()
            });
            window.location.href = `food.html?${queryParams.toString()}`;
        }

        function addMealToExisting(mealIndex) {
            // Redirect to meals.html to select a saved meal to add to this specific day meal
            window.location.href = `meals.html?day=${currentDate}&meal=${mealIndex}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
