<div id="food-list-container">
    <div class="food-list-header">
        <div class="search-container">
            <input 
                type="text" 
                id="food-search-input" 
                placeholder="Search foods..." 
                class="search-input"
            >
            <select id="results-limit" class="results-limit-select">
                <option value="10">10 results</option>
                <option value="25">25 results</option>
                <option value="50">50 results</option>
                <option value="100">100 results</option>
            </select>
        </div>
        <button id="add-food-btn" class="add-food-btn" onclick="window.location.href='edit_food.html?action=add'">
            + Add Food
        </button>
        <button id="api-search-btn" class="api-search-btn" onclick="window.location.href='food_api.html'">
            API Search
        </button>
        <button id="single-btn" class="single-btn" onclick="addSingleFood()" style="display: none;">
            Single
        </button>
    </div>
    
    <div id="food-list-results">
        <div class="loading">Loading foods...</div>
    </div>
</div>

<script>
(function() {
    let searchTimeout;
    
    function searchFoods() {
        const query = $('#food-search-input').val().trim();
        const limit = $('#results-limit').val();
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Show loading
        $('#food-list-results').html('<div class="loading">Searching...</div>');
        
        // Debounce search
        searchTimeout = setTimeout(() => {
            const searchParams = new URLSearchParams();
            if (query) {
                searchParams.append('q', query);
            }
            searchParams.append('limit', limit);
            
            $.ajax({
                url: `/api/food/search?${searchParams.toString()}`,
                method: 'GET',
                success: function(foods) {
                    displayFoods(foods);
                },
                error: function(xhr, status, error) {
                    console.error('Error searching foods:', error);
                    $('#food-list-results').html('<div class="error">Error loading foods</div>');
                }
            });
        }, 300);
    }
    
    function displayFoods(foods) {
        if (foods.length === 0) {
            $('#food-list-results').html('<div class="no-results">No foods found</div>');
            return;
        }
        
        const foodsHtml = foods.map(food => {
            const quantityInfo = food.quantities && food.quantities.length > 0 
                ? food.quantities.map(q => `${q.name} (${q.weight}g)`).join(', ')
                : 'No quantities defined';
            
            return `
                <div class="food-item" data-food-id="${food._id}">
                    <div class="food-info">
                        <span class="food-name">${escapeHtml(food.name)}</span>
                        <span class="food-kcal">${food.kcal_per_100g} kcal/100g</span>
                    </div>
                    <div class="food-actions">
                        <button class="edit-food-btn" onclick="window.location.href='edit_food.html?action=edit&id=${food._id}'">
                            Edit
                        </button>
                        <button class="select-food-btn" onclick="selectFood('${food._id}', '${escapeHtml(food.name)}')">
                            Select
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        $('#food-list-results').html(`<div class="food-list">${foodsHtml}</div>`);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Store food data for calculations
    let currentFoodData = {};
    
    // Global function for updating weight calculation
    window.updateWeightCalculationMeal = function(foodId) {
        const weight = parseInt($(`#weight-${foodId}`).val()) || 0;
        if (weight <= 0) return;
        
        const food = currentFoodData[foodId];
        if (food) {
            const kcal = Math.round(food.kcal_per_100g * (weight / 100));
            $(`#calories-${foodId}`).text(`${kcal} kcal`);
        }
    };
    
    // Global function for selecting a food (can be overridden by parent page)
    // Only define default behavior if no custom selectFood function exists
    if (typeof window.selectFood !== 'function') {
        window.selectFood = function(foodId, foodName) {
            console.log('Selected food:', foodId, foodName);
            // This is the default behavior - show alert
            alert(`Selected: ${foodName}`);
        };
    }
    
    // Event listeners
    $('#food-search-input').on('input', searchFoods);
    $('#results-limit').on('change', searchFoods);
    
    // Check if we're in add-to-meal mode and show Single button
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('action') === 'add-to-meal') {
        $('#single-btn').show();
    }
    
    // Global function for adding single food
    window.addSingleFood = function() {
        const searchText = $('#food-search-input').val().trim();
        if (!searchText) {
            alert('Please enter a food name in the search field first');
            return;
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const dayParam = urlParams.get('day');
        const mealParam = urlParams.get('meal');
        
        if (!dayParam || !mealParam) {
            alert('Missing day or meal parameters');
            return;
        }
        
        // Create a fake food ID for the single food item
        const singleFoodId = 'single-' + Date.now();
        
        // Create fake food data with 100 kcal per 100g and no quantities
        const fakeFood = {
            _id: singleFoodId,
            name: searchText,
            kcal_per_100g: 100,
            quantities: []
        };
        
        // Store the fake food data
        currentFoodData[singleFoodId] = fakeFood;
        
        // Create and display the expanded food item
        displaySingleFoodItem(fakeFood, dayParam, mealParam);
    };
    
    function displaySingleFoodItem(food, dayParam, mealParam) {
        // Create a food item div similar to search results
        const foodItemHtml = `
            <div class="food-item expanded" data-food-id="${food._id}">
                <div class="food-info">
                    <span class="food-name">${escapeHtml(food.name)}</span>
                    <span class="food-kcal">${food.kcal_per_100g} kcal/100g</span>
                </div>
                <div class="quantity-selection">
                    <h4>Add to Meal: ${food.name}</h4>
                    <div class="food-base-info">
                        <div class="food-calories">${food.kcal_per_100g} kcal per 100g</div>
                    </div>
                    
                    <div class="quantity-controls-meal">
                        <div class="quantity-fields-meal">
                            <input type="number" 
                                   class="weight-input-meal" 
                                   id="weight-${food._id}"
                                   value="100" 
                                   min="1" 
                                   step="1"
                                   onchange="updateWeightCalculationMeal('${food._id}')">
                            <span>g</span>
                        </div>
                        <div class="calculated-calories-meal" id="calories-${food._id}">
                            ${food.kcal_per_100g} kcal
                        </div>
                    </div>
                    
                    <div class="quantity-actions">
                        <button class="btn-add-to-meal" onclick="addSingleFoodToMeal('${food._id}', '${escapeHtml(food.name)}', '${dayParam}', '${mealParam}')">Add to Meal</button>
                        <button class="btn-cancel" onclick="cancelSingleFood('${food._id}')">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        // Add to the beginning of food list results
        $('#food-list-results').html(foodItemHtml + $('#food-list-results').html());
    }
    
    // Global function for adding single food to meal
    window.addSingleFoodToMeal = function(foodId, foodName, dayParam, mealParam) {
        const weight = parseInt($(`#weight-${foodId}`).val()) || 0;
        
        if (weight <= 0) {
            alert('Please enter a valid weight');
            return;
        }
        
        // Prepare data to send - use foodName directly since it's not in the database
        const foodData = {
            foodId: foodName, // Use the food name as ID since it doesn't exist in DB
            weight: weight
        };
        
        // Add food to meal via API
        $.ajax({
            url: `/day/${dayParam}/meals/${mealParam}/foods`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(foodData),
            success: function(result) {
                // Return to day view
                window.location.href = `day.html?yyyymmdd=${dayParam}`;
            },
            error: function(xhr, status, error) {
                console.error('Error adding food to meal:', error);
                alert('Error adding food to meal: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    };
    
    // Global function for canceling single food
    window.cancelSingleFood = function(foodId) {
        $(`.food-item[data-food-id="${foodId}"]`).remove();
    };
    
    // Initial load
    searchFoods();
})();
</script>

<style>
#food-list-container {
    max-width: 800px;
    margin: 0 auto;
}

.food-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 20px;
}

.search-container {
    display: flex;
    flex: 1;
    gap: 10px;
    align-items: center;
}

.search-input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--grey-two);
    border-radius: 0.25rem;
    font-size: 1rem;
}

.search-input:focus {
    outline: none;
    border-color: var(--yellow-strongest);
    box-shadow: 0 0 0 2px var(--yellow-faint);
}

.results-limit-select {
    padding: 10px;
    border: 1px solid var(--grey-two);
    border-radius: 0.25rem;
    background: white;
    font-size: 0.9rem;
}

.add-food-btn {
    background-color: var(--yellow-strongest);
    color: black;
    border: none;
    padding: 10px 20px;
    border-radius: 0.25rem;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
}

.add-food-btn:hover {
    background-color: var(--dark-yellow);
}

.api-search-btn {
    background-color: var(--grey-three);
    color: var(--grey-five);
    border: none;
    padding: 10px 20px;
    border-radius: 0.25rem;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
}

.api-search-btn:hover {
    background-color: var(--grey-four);
    color: white;
}

.single-btn {
    background-color: var(--yellow-stronger);
    color: black;
    border: none;
    padding: 10px 20px;
    border-radius: 0.25rem;
    cursor: pointer;
    font-weight: bold;
    white-space: nowrap;
}

.single-btn:hover {
    background-color: var(--yellow-strongest);
}

.loading, .error, .no-results {
    text-align: center;
    padding: 40px 20px;
    color: var(--grey-four);
    font-style: italic;
}

.error {
    color: red;
}

.food-list {
    display: grid;
    gap: 15px;
}

.food-item {
    border: 1px solid var(--grey-two);
    border-radius: 0.5rem;
    padding: 15px;
    background: white;
    transition: box-shadow 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.food-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.food-info {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 1;
}

.food-name {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--grey-five);
    min-width: 200px;
}

.food-kcal {
    color: var(--grey-four);
    font-weight: 500;
    font-size: 0.95rem;
}

.food-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}

.edit-food-btn, .select-food-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 0.9rem;
}

.edit-food-btn {
    background-color: var(--grey-two);
    color: var(--grey-five);
}

.edit-food-btn:hover {
    background-color: var(--grey-three);
}

.select-food-btn {
    background-color: var(--yellow-stronger);
    color: black;
}

.select-food-btn:hover {
    background-color: var(--yellow-strongest);
}

@media (max-width: 768px) {
    .food-list-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-container {
        flex-direction: row;
        gap: 8px;
    }
    
    .search-input {
        flex: 2;
        min-width: 0;
    }
    
    .results-limit-select {
        flex: 0 0 auto;
        min-width: 100px;
    }
    
    .food-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .food-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .food-name {
        min-width: auto;
    }
    
    .food-actions {
        flex-direction: row;
        justify-content: flex-end;
    }
}

@media (max-width: 480px) {
    .food-actions {
        flex-direction: column;
    }
}

/* Styles for single food quantity selection */
.quantity-selection {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border: 2px solid var(--yellow-strongest);
    border-radius: 8px;
}

.quantity-selection h4 {
    margin: 0 0 15px 0;
    color: var(--grey-five);
    font-weight: bold;
}

.food-base-info {
    margin-bottom: 15px;
}

.food-brand {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 4px;
}

.food-calories {
    color: #666;
    font-size: 0.9rem;
}

.quantity-controls-meal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 1rem;
}

.quantity-fields-meal {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.weight-input-meal {
    width: 4ch;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-align: center;
    font-size: 0.9rem;
}

.calculated-calories-meal {
    font-weight: bold;
    color: #e74c3c;
    min-width: 80px;
    text-align: right;
}

.quantity-actions {
    display: flex;
    gap: 10px;
}

.btn-add-to-meal {
    background-color: var(--yellow-strongest);
    color: black;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.btn-add-to-meal:hover {
    background-color: var(--dark-yellow);
}

.btn-cancel {
    background-color: var(--grey-two);
    color: var(--grey-five);
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
}

.btn-cancel:hover {
    background-color: var(--grey-three);
}
</style>
