<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Recipe - Food Tracker</title>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/tracker.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
    <div id="page-container">
        <div id="navbar-container"></div>
        <div class="header-section">
            <h1 id="pageTitle">Create New Recipe</h1>
            <div class="header-actions">
                <a href="/recipes.html" class="btn btn-outline">Back to Recipes</a>
            </div>
        </div>

        <form id="recipeForm" class="recipe-form">
            <!-- Recipe basic info -->
            <div class="form-section">
                <h2>Recipe Information</h2>
                <div id="editModeIndicator" class="edit-mode-indicator" style="display: none;">
                    <p><strong>Editing existing recipe</strong> - Make your changes below</p>
                </div>
                
                <div class="form-group">
                    <label for="recipeName">Recipe Name *</label>
                    <input type="text" id="recipeName" required class="form-control" placeholder="Enter recipe name">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="recipePortions">Portions *</label>
                        <input type="number" id="recipePortions" required class="form-control" placeholder="Number of portions" min="1" step="1" value="4">
                    </div>
                </div>
            </div>

            <!-- Food selection -->
            <div class="form-section">
                <h2>Ingredients</h2>
                <p class="section-description">Add ingredients to your recipe. Search and select foods, then specify the weight for each.</p>
                
                <div class="add-food-section">
                    <div class="food-search-group">
                        <input type="text" id="foodSearch" placeholder="Search for ingredient..." class="form-control">
                        <button type="button" id="searchFoodBtn" class="btn btn-secondary">Search</button>
                    </div>
                    
                    <div id="foodSearchResults" class="food-search-results" style="display: none;">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>

                <div id="selectedFoods" class="selected-foods">
                    <h3>Selected Ingredients</h3>
                    <div id="selectedFoodsList" class="selected-foods-list">
                        <p class="empty-message">No ingredients selected yet. Search and add ingredients above.</p>
                    </div>
                </div>

                <!-- Total calories display -->
                <div class="total-calories">
                    <h3>Total Recipe Calories: <span id="totalCalories">0</span> kcal</h3>
                    <p>Calories per portion: <span id="caloriesPerPortion">0</span> kcal</p>
                </div>
            </div>

            <!-- Recipe steps -->
            <div class="form-section">
                <h2>Instructions</h2>
                <p class="section-description">Write the recipe instructions (optional).</p>
                
                <div class="form-group">
                    <label for="recipeSteps">Recipe Steps</label>
                    <textarea id="recipeSteps" class="form-control" rows="8" placeholder="Enter recipe instructions...

Example:
1. Preheat oven to 180Â°C
2. Mix all dry ingredients in a bowl
3. Add wet ingredients and combine
4. Bake for 25-30 minutes"></textarea>
                </div>
            </div>

            <!-- Form actions -->
            <div class="form-actions">
                <button type="button" id="cancelBtn" class="btn btn-outline">Cancel</button>
                <button type="submit" id="submitBtn" class="btn btn-primary">Create Recipe</button>
            </div>
        </form>
    </div>

    <style>
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .recipe-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-section h2 {
            margin: 0 0 1rem 0;
            color: #333;
        }

        .section-description {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control textarea {
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.5;
        }

        .food-search-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .food-search-group .form-control {
            flex: 1;
        }

        .food-search-results {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }

        .food-result-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .food-result-item:last-child {
            border-bottom: none;
        }

        .food-result-item:hover {
            background-color: #f8f9fa;
        }

        .food-result-name {
            font-weight: bold;
            color: #333;
        }

        .food-result-brand {
            color: #666;
            font-size: 0.9rem;
        }

        .food-result-details {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .selected-foods {
            margin-top: 2rem;
        }

        .selected-foods h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .empty-message {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 2rem;
        }

        .selected-food-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
        }

        .selected-food-info {
            flex: 1;
        }

        .selected-food-name {
            font-weight: bold;
            color: #333;
        }

        .selected-food-brand {
            color: #666;
            font-size: 0.9rem;
        }

        .selected-food-base-calories {
            color: #666;
            font-size: 0.9rem;
        }

        .quantity-controls {
            display: flex;
            margin: 0 1rem;
        }

        .quantity-fields {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-multiplier {
            width: 2ch;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }

        .quantity-selector {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            min-width: 120px;
            max-width: 180px;
            font-size: 0.9rem;
        }

        .weight-input {
            width: 4ch;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }

        .calculated-calories {
            font-weight: bold;
            color: #e74c3c;
            min-width: 80px;
            text-align: right;
        }

        .remove-food-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .remove-food-btn:hover {
            background: #c82333;
        }

        .total-calories {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 2rem;
        }

        .total-calories h3 {
            margin: 0 0 0.5rem 0;
            color: #28a745;
            font-size: 1.5rem;
        }

        .total-calories p {
            margin: 0;
            color: #28a745;
            font-size: 1.1rem;
            font-weight: bold;
        }



        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 2rem 0;
        }

        .edit-mode-indicator {
            background: #e8f4f8;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #0c5460;
        }

        .edit-mode-indicator p {
            margin: 0;
        }

        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .food-search-group {
                flex-direction: column;
            }

            .selected-food-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .quantity-controls {
                margin: 0;
            }

            .quantity-fields {
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>

    <script>
        let selectedFoods = [];
        let editingRecipeId = null;

        $(document).ready(function() {
            loadNavbar();
            
            // Check if we're editing an existing recipe
            const urlParams = new URLSearchParams(window.location.search);
            editingRecipeId = urlParams.get('edit');
            
            if (editingRecipeId) {
                $('#pageTitle').text('Edit Recipe');
                $('#submitBtn').text('Update Recipe');
                $('#editModeIndicator').show();
                loadRecipeForEditing(editingRecipeId);
            } else {
                $('#pageTitle').text('Create New Recipe');
                $('#submitBtn').text('Create Recipe');
                $('#editModeIndicator').hide();
            }

            // Food search functionality with real-time search
            let foodSearchTimeout;
            
            $('#foodSearch').on('input', function() {
                clearTimeout(foodSearchTimeout);
                const query = $(this).val().trim();
                
                if (query.length === 0) {
                    $('#foodSearchResults').hide();
                    return;
                }
                
                // Debounce search by 300ms to avoid too many requests
                foodSearchTimeout = setTimeout(() => {
                    searchFoods(query);
                }, 300);
            });

            $('#searchFoodBtn').click(() => searchFoods());
            $('#foodSearch').keypress(function(e) {
                if (e.which === 13) {
                    searchFoods();
                }
            });

            // Update calories per portion when portions change
            $('#recipePortions').on('input', updateCaloriesPerPortion);

            // Form submission
            $('#recipeForm').submit(function(e) {
                e.preventDefault();
                saveRecipe();
            });

            // Cancel button
            $('#cancelBtn').click(function() {
                window.location.href = '/recipes.html';
            });
        });

        function loadNavbar() {
            $.get('/_navbar.html', function(data) {
                $('#navbar-container').html(data);
            }).fail(function() {
                console.error('Failed to load navbar');
            });
        }

        function loadRecipeForEditing(recipeId) {
            $.get(`/api/recipes/${encodeURIComponent(recipeId)}`)
                .done(function(recipe) {
                    $('#recipeName').val(recipe.name);
                    $('#recipePortions').val(recipe.portions);
                    $('#recipeSteps').val(recipe.steps);
                    
                    // Load foods with quantity information
                    const foodPromises = recipe.foods.map(recipeFood => {
                        return $.get(`/api/food/search?q=${encodeURIComponent(recipeFood.title)}&limit=1`)
                            .then(foods => {
                                const matchedFood = foods.find(f => f.name === recipeFood.title);
                                return {
                                    _id: matchedFood ? matchedFood._id : null,
                                    title: recipeFood.title,
                                    brand: matchedFood ? (matchedFood.brand || '') : '',
                                    kcal_per_100g: matchedFood ? matchedFood.kcal_per_100g : Math.round(recipeFood.kcal / (recipeFood.weight / 100)),
                                    quantities: matchedFood ? (matchedFood.quantities || []) : [],
                                    weight: recipeFood.weight,
                                    kcal: recipeFood.kcal,
                                    quantity: recipeFood.quantity || null,
                                    quantity_type: recipeFood.quantity_type || null
                                };
                            })
                            .catch(() => {
                                return {
                                    _id: null,
                                    title: recipeFood.title,
                                    brand: '',
                                    kcal_per_100g: Math.round(recipeFood.kcal / (recipeFood.weight / 100)),
                                    quantities: [],
                                    weight: recipeFood.weight,
                                    kcal: recipeFood.kcal,
                                    quantity: recipeFood.quantity || null,
                                    quantity_type: recipeFood.quantity_type || null
                                };
                            });
                    });
                    
                    Promise.all(foodPromises)
                        .then(foods => {
                            selectedFoods = foods;
                            updateSelectedFoodsDisplay();
                        })
                        .catch(error => {
                            console.error('Error loading food details:', error);
                            selectedFoods = recipe.foods.map(food => ({
                                _id: null,
                                title: food.title,
                                brand: '',
                                kcal_per_100g: Math.round(food.kcal / (food.weight / 100)),
                                quantities: [],
                                weight: food.weight,
                                kcal: food.kcal,
                                quantity: food.quantity || null,
                                quantity_type: food.quantity_type || null
                            }));
                            updateSelectedFoodsDisplay();
                        });
                })
                .fail(function(xhr) {
                    console.error('Error loading recipe:', xhr.responseText);
                    alert('Error loading recipe: ' + (xhr.responseJSON?.error || 'Unknown error'));
                    window.location.href = '/recipes.html';
                });
        }

        function searchFoods(query) {
            // If no query provided, get it from the input
            if (query === undefined) {
                query = $('#foodSearch').val().trim();
            }
            
            if (!query) {
                $('#foodSearchResults').hide();
                return;
            }

            $.get(`/api/food/search?q=${encodeURIComponent(query)}&limit=10`)
                .done(function(foods) {
                    displayFoodSearchResults(foods);
                })
                .fail(function(xhr) {
                    console.error('Error searching foods:', xhr.responseText);
                    alert('Error searching foods: ' + (xhr.responseJSON?.error || 'Unknown error'));
                });
        }

        function displayFoodSearchResults(foods) {
            const resultsContainer = $('#foodSearchResults');
            
            if (foods.length === 0) {
                resultsContainer.html('<div class="food-result-item">No foods found</div>');
            } else {
                let html = '';
                foods.forEach(food => {
                    html += `
                        <div class="food-result-item" onclick="selectFood('${food._id}')">
                            <div class="food-result-name">${escapeHtml(food.name)}</div>
                            ${food.brand ? `<div class="food-result-brand">${escapeHtml(food.brand)}</div>` : ''}
                            <div class="food-result-details">${food.kcal_per_100g} kcal per 100g</div>
                        </div>
                    `;
                });
                resultsContainer.html(html);
            }
            
            resultsContainer.show();
        }

        function selectFood(foodId) {
            $.get(`/api/food/${foodId}`)
                .done(function(food) {
                    if (selectedFoods.some(f => f._id === food._id)) {
                        alert('This ingredient is already added to the recipe.');
                        return;
                    }

                    selectedFoods.push({
                        _id: food._id,
                        title: food.name,
                        brand: food.brand || '',
                        kcal_per_100g: food.kcal_per_100g,
                        quantities: food.quantities || [],
                        weight: 100,
                        kcal: Math.round(food.kcal_per_100g * 1),
                        quantity: null,
                        quantity_type: null
                    });

                    updateSelectedFoodsDisplay();
                    $('#foodSearchResults').hide();
                    $('#foodSearch').val('');
                })
                .fail(function(xhr) {
                    console.error('Error loading food details:', xhr.responseText);
                    alert('Error loading food: ' + (xhr.responseJSON?.error || 'Unknown error'));
                });
        }

        function updateSelectedFoodsDisplay() {
            const container = $('#selectedFoodsList');
            
            if (selectedFoods.length === 0) {
                container.html('<p class="empty-message">No ingredients selected yet. Search and add ingredients above.</p>');
            } else {
                let html = '';
                selectedFoods.forEach((food, index) => {
                    const hasQuantities = food.quantities && food.quantities.length > 0;
                    const hasSavedQuantity = food.quantity || food.quantity_type;
                    const showQuantityControls = hasQuantities || hasSavedQuantity;
                    
                    let quantityOptions = '<option value="">Select quantity</option>';
                    if (hasQuantities) {
                        food.quantities.forEach(qty => {
                            const selected = food.quantity_type === qty.name ? 'selected' : '';
                            quantityOptions += `<option value="${qty.weight}" ${selected}>${escapeHtml(qty.name)} (${qty.weight}g)</option>`;
                        });
                    } else if (food.quantity_type) {
                        quantityOptions += `<option value="" selected>${escapeHtml(food.quantity_type)} (custom)</option>`;
                    }
                    
                    html += `
                        <div class="selected-food-item">
                            <div class="selected-food-info">
                                <div class="selected-food-name">${escapeHtml(food.title)}</div>
                                ${food.brand ? `<div class="selected-food-brand">${escapeHtml(food.brand)}</div>` : ''}
                                <div class="selected-food-base-calories">${food.kcal_per_100g} kcal per 100g</div>
                            </div>
                            
                            <div class="quantity-controls">
                                <div class="quantity-fields">
                                    ${showQuantityControls ? `
                                        <input type="number" 
                                               class="quantity-multiplier" 
                                               value="${food.quantity || ''}"
                                               placeholder="Qty"
                                               onchange="updateQuantityCalculation(${index})">
                                        <select class="quantity-selector" onchange="updateQuantityCalculation(${index})">
                                            ${quantityOptions}
                                        </select>
                                    ` : ''}
                                    <input type="number" 
                                           class="weight-input" 
                                           value="${food.weight}" 
                                           min="1" 
                                           step="1"
                                           onchange="updateFoodWeight(${index}, this.value)">
                                    <span>g</span>
                                </div>
                            </div>
                            
                            <div class="calculated-calories">${food.kcal} kcal</div>
                            
                            <button type="button" class="remove-food-btn" onclick="removeFood(${index})">Ã</button>
                        </div>
                    `;
                });
                container.html(html);
            }
            
            updateTotalCalories();
        }

        function updateQuantityCalculation(index) {
            const foodItem = $('.selected-food-item').eq(index);
            const multiplier = parseFloat(foodItem.find('.quantity-multiplier').val()) || null;
            const selectedQuantityWeight = parseInt(foodItem.find('.quantity-selector').val()) || 0;
            
            selectedFoods[index].quantity = multiplier;
            
            if (selectedQuantityWeight > 0 && multiplier) {
                const matchingQuantity = selectedFoods[index].quantities.find(q => q.weight === selectedQuantityWeight);
                const quantityTypeName = matchingQuantity ? matchingQuantity.name : '';
                selectedFoods[index].quantity_type = quantityTypeName;
                
                const newWeight = Math.round(multiplier * selectedQuantityWeight);
                selectedFoods[index].weight = newWeight;
                selectedFoods[index].kcal = Math.round(selectedFoods[index].kcal_per_100g * (newWeight / 100));
                
                foodItem.find('.weight-input').val(newWeight);
                updateSelectedFoodsDisplay();
            } else {
                selectedFoods[index].quantity_type = null;
                if (!multiplier) {
                    selectedFoods[index].quantity = null;
                }
            }
        }

        function updateFoodWeight(index, newWeight) {
            const weight = parseInt(newWeight) || 0;
            if (weight <= 0) return;
            
            selectedFoods[index].weight = weight;
            selectedFoods[index].kcal = Math.round(selectedFoods[index].kcal_per_100g * (weight / 100));
            
            const currentQuantity = selectedFoods[index].quantity;
            const currentQuantityType = selectedFoods[index].quantity_type;
            if (currentQuantity && currentQuantityType) {
                const matchingQty = selectedFoods[index].quantities.find(q => q.name === currentQuantityType);
                if (matchingQty) {
                    const expectedWeight = Math.round(currentQuantity * matchingQty.weight);
                    if (weight !== expectedWeight) {
                        selectedFoods[index].quantity = null;
                        selectedFoods[index].quantity_type = null;
                    }
                }
            }
            
            updateSelectedFoodsDisplay();
        }

        function removeFood(index) {
            selectedFoods.splice(index, 1);
            updateSelectedFoodsDisplay();
        }

        function updateTotalCalories() {
            const total = selectedFoods.reduce((sum, food) => sum + food.kcal, 0);
            $('#totalCalories').text(total);
            updateCaloriesPerPortion();
        }

        function updateCaloriesPerPortion() {
            const total = selectedFoods.reduce((sum, food) => sum + food.kcal, 0);
            const portions = parseInt($('#recipePortions').val()) || 1;
            const perPortion = Math.round(total / portions);
            $('#caloriesPerPortion').text(perPortion);
        }

        function saveRecipe() {
            const recipeName = $('#recipeName').val().trim();
            const recipeSteps = $('#recipeSteps').val().trim();
            const recipePortions = parseInt($('#recipePortions').val()) || 1;
            
            if (!recipeName) {
                alert('Please enter a recipe name.');
                return;
            }

            if (!recipeSteps) {
                alert('Please enter recipe instructions.');
                return;
            }

            if (recipePortions <= 0) {
                alert('Please enter a valid number of portions.');
                return;
            }

            if (selectedFoods.length === 0) {
                alert('Please add at least one ingredient to the recipe.');
                return;
            }

            const recipeData = {
                name: recipeName,
                foods: selectedFoods.map(food => {
                    const foodItem = {
                        title: food.title,
                        kcal: food.kcal,
                        weight: food.weight
                    };
                    
                    if (food.brand) {
                        foodItem.brand = food.brand;
                    }
                    
                    if (food.quantity !== null && food.quantity !== undefined) {
                        foodItem.quantity = food.quantity;
                    }
                    if (food.quantity_type) {
                        foodItem.quantity_type = food.quantity_type;
                    }
                    
                    return foodItem;
                }),
                steps: recipeSteps,
                portions: recipePortions
            };

            console.log('Saving recipe:', recipeData);

            const url = editingRecipeId ? `/api/recipes/${encodeURIComponent(editingRecipeId)}` : '/api/recipes';
            const method = editingRecipeId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(recipeData),
                success: function(response) {
                    console.log('Recipe saved successfully:', response);
                    window.location.href = '/recipes.html';
                },
                error: function(xhr) {
                    console.error('Error saving recipe:', xhr.responseText);
                    const errorMsg = xhr.responseJSON?.error || 'Unknown error occurred';
                    alert('Error saving recipe: ' + errorMsg);
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
